rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      allow read: if request.auth != null; // Allow all auth users to read profiles for the forum

      allow create: if request.auth != null && request.auth.uid == userId &&
                     request.resource.data.username is string && request.resource.data.username.size() > 0 &&
                     request.resource.data.email is string && request.resource.data.email.size() > 0 &&
                     request.resource.data.createdAt is timestamp;


      allow update: if request.auth != null && request.auth.uid == userId &&
                     request.resource.data.diff(resource.data).changedKeys().hasOnly([
                         'username',
                         'profilePictureUrl',
                         'bio'
                     ]);

      match /collectionSlot/{slotId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      match /userBirdImage/{userBirdImageId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null && request.auth.uid == userId &&
                      request.resource.data.userId == userId;
        allow update, delete: if request.auth != null && request.auth.uid == userId &&
                              resource.data.userId == userId;
      }
    }

    match /birds/{birdId} {
      allow read: if true;
      allow write: if false;
    }

    match /birdFacts/{birdId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;

      match /hunterFacts/{hunterFactsDocId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }

    match /userBirds/{userBirdId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /locations/{locationId} {
      allow read, create: if request.auth != null;
      allow update, delete: if false;
    }

    match /identifications/{identificationId} {
      allow read: if request.auth != null;
      allow create: if false;
      allow update, delete: if false;
    }

    match /media/{mediaId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    match /userBirdSightings/{userBirdSightingId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    match /eBirdApiSightings/{ebirdSightingId} {
        allow read: if request.auth != null;
        allow write: if false;
    }

    match /hunterSightings/{sightingId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // NEW FORUM RULES
    match /forumThreads/{threadId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow update: if request.auth != null; // Allow updates for likes and view counts
        allow delete: if request.auth != null && resource.data.userId == request.auth.uid;

        match /comments/{commentId} {
            allow read: if request.auth != null;
            allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
            allow update: if request.auth != null; // Allow updates for comment likes
            allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
        }
    }

    // Reports: Allow any authenticated user to create a report.
    // Reading/Managing reports should be restricted (e.g., to an admin role, not yet implemented here).
    match /reports/{reportId} {
        allow create: if request.auth != null;
        allow read, update, delete: if false; // Only manageable through the Firebase Console or an admin dashboard
    }

    // eBird cache is read-only for clients (written by Cloud Function).
    match /ebird_ga_cache/{document} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}