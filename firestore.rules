rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Allow authenticated users to query the 'users' collection (e.g., for displayName checks).
    match /users/{userId} {
      // Allow a user to create their own profile, but prevent direct writes to calculated totals.
      // Allow a user to update their own profile, except for the calculated totals.
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      // Allow update only if totalBirds, duplicateBirds, and totalPoints are unchanged (only CF can change these)
      // Also allow updating 'profilePictureUrl', 'username', and 'bio'.
      allow update: if request.auth != null && request.auth.uid == userId &&
                     (!("totalBirds" in request.resource.data) || request.resource.data.totalBirds == resource.data.totalBirds) &&
                     (!("duplicateBirds" in request.resource.data) || request.resource.data.duplicateBirds == resource.data.duplicateBirds) &&
                     (!("totalPoints" in request.resource.data) || request.resource.data.totalPoints == resource.data.totalPoints) &&
                     // Only allow changes to profilePictureUrl, username, and bio (or keep existing values)
                     request.resource.data.diff(resource.data).affectedKeys().hasOnly([
                         "profilePictureUrl",
                         "username",
                         "bio",
                         "totalBirds", // Include these if they are to be unchanged, ensuring no app client updates them
                         "duplicateBirds",
                         "totalPoints"
                     ]);

      // Subcollection for user-specific collection slots
      match /collectionSlot/{slotId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // The 'birds' collection contains public, static reference data.
    // ANYONE, even unauthenticated users, can read this data.
    match /birds/{birdId} {
      allow read: if true;
      allow write: if false; // Only Cloud Functions can write to this.
    }

    // Bird Facts and Hunter Facts: Allow authenticated users to read all facts.
    match /birdFacts/{birdId} {
      allow read: if request.auth != null;

      // Allow read for hunterFacts subcollection documents
      match /hunterFacts/{hunterFactsDocId} {
        allow read: if request.auth != null;
      }
    }

    // 'userBirds' contains records of captures specific to a user.
    // Now includes pointsEarned and isDuplicate, which are set by the app, but totals updated by CF.
    match /userBirds/{userBirdId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Locations can be created and read by any authenticated user.
    // The write access remains unchanged as they are shared resources.
    match /locations/{locationId} {
      allow read, create: if request.auth != null;
      allow update, delete: if false;
    }

    // AI training data can be read and created by any authenticated user.
    match /identifications/{identificationId} {
      allow read, create: if request.auth != null;
      allow update, delete: if false;
    }

    // User can only manage their own media.
    match /media/{mediaId} {
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // User-generated Bird Sightings - Now 'userBirdSightings'
    // Users can create and update their own, but NOT delete.
    match /userBirdSightings/{userBirdSightingId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.resource.data.user_sighting.userId == request.auth.uid;
        allow update: if request.auth != null && resource.data.user_sighting.userId == request.auth.uid;
        // Removed delete permission for clients
    }

    // eBird API Sightings - New collection, read-only for authenticated users (written by Cloud Function)
    match /eBirdApiSightings/{ebirdSightingId} {
        allow read: if request.auth != null;
        allow write: if false; // Only Cloud Functions should write to this
    }

    match /hunterSightings/{sightingId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Forum rules.
    match /threads/{threadId} {
        allow read: if request.auth != null;
        allow create, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    match /threads/{threadId}/posts/{postId} {
        allow read: if request.auth != null;
        allow create, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // eBird cache is read-only for clients (written by Cloud Function).
    match /ebird_ga_cache/{document} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}